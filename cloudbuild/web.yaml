steps:
  - name: gcr.io/cloud-builders/docker
    entrypoint: sh
    args: ["-c", "docker pull $_IMAGE_WEB || true"]
  - name: gcr.io/cloud-builders/docker
    env: ["DOCKER_BUILDKIT=1"]
    args:
      - "build"
      - "--build-arg"
      - "BUILDKIT_INLINE_CACHE=1"
      - "--build-arg"
      - "CACHE_BUST=$_CACHE_BUST"
      - "--cache-from"
      - "$_IMAGE_WEB"
      - "-f"
      - "apps/web/Dockerfile"
      - "-t"
      - "$_IMAGE_WEB"
      - "--build-arg"
      - "NEXT_PUBLIC_API_BASE_URL=$_API_BASE_URL"
      - "."
  - name: gcr.io/cloud-builders/docker
    args: ["push", "$_IMAGE_WEB"]
  - name: gcr.io/cloud-builders/gcloud
    args: ["run", "services", "update", "$_WEB_SERVICE", "--image", "$_IMAGE_WEB", "--region", "$_REGION", "--quiet"]
images:
  - "$_IMAGE_WEB"
options:
  # BYOSA (build.service_account) requires Cloud Logging or an explicit logs bucket.
  logging: CLOUD_LOGGING_ONLY
substitutions:
  _REGION: "us-central1"
  _WEB_SERVICE: "crm-web"
  _CACHE_BUST: "0"
  _IMAGE_WEB: "us-central1-docker.pkg.dev/probable-dream-484923-n7/crm/web:latest"
  _API_BASE_URL: "https://api.surrogacyforce.com"
