Surrogacy CRM Platform — 12-Week Roadmap (AI-ready, Multi-tenant, OSS-ready)
Last updated: 2025-12-14

Assumptions (important)
- Multi-tenant via shared DB + shared schema, with `organization_id` on all domain rows.
- Each user account belongs to exactly ONE organization (no org switcher). If the same person works for another org, they create a separate account.
- Tenant context is derived from auth (JWT/session includes `org_id` and `role`); the client does NOT send an org id header/path for scoping.
- AI is optional (off by default) and BYOK (org-managed key stored server-side in DB, encrypted).

Week 1 — Setup & foundations (repo + tooling + skeleton apps) ✓ COMPLETE
Backend
✓ FastAPI project structure (`apps/api/app/`)
✓ Postgres connectivity (Docker Compose for dev)
✓ Alembic migrations + baseline migration (`0001_baseline.py`)
✓ Central request context dependency (`get_current_session` returns `{user_id, org_id, role}`)
✓ `/health` endpoint (DB connectivity test)
Frontend
✓ Next.js App Router + TypeScript strict
✓ Tailwind + shadcn/ui installed
✓ Layout shell (sidebar/topbar) + placeholder routes (`(app)/dashboard`, `(app)/leads`, `(app)/settings`)
Tooling/Process
- CI on PRs: (to be configured)
✓ `.env` settings documented in README (formal `.env.example` files pending)
Deliverable
✓ FE loads, BE loads, DB connects; skeleton exists

Week 2 — Auth + tenant isolation (the "don't regret later" week) ✓ COMPLETE
Backend
✓ Tables:
  ✓ organizations
  ✓ users
  ✓ memberships (user_id ↔ org_id ↔ role) with constraint enforcing 1 org per user (UNIQUE(user_id))
  ✓ auth_identities (SSO provider linking)
  ✓ org_invites (with partial unique index for pending invites)
✓ Auth: Google OAuth (Workspace SSO) + cookie-based session (JWT in HTTP-only cookie) + GET `/auth/me`
✓ Invite-only access (org_invites + CLI bootstrap command)
✓ Optional domain allowlist via `ALLOWED_EMAIL_DOMAINS`
✓ CSRF protection for mutations (`X-Requested-With: XMLHttpRequest`)
✓ Centralized authorization helpers (role checks; membership checks) in `core/deps.py`
✓ Centralized query scoping helper: `get_org_scope` dependency
✓ Seed/bootstrap path:
  ✓ CLI: `python -m app.cli create-org` for first org + manager invite
  ✓ Dev-only endpoints (`/dev/seed`, `/dev/login-as`) guarded by ENV + X-Dev-Secret header
✓ Service layer: `auth_service.py`, `user_service.py`, `org_service.py`, `google_oauth.py`
✓ Schemas: `auth.py`, `user.py`, `org.py`, `invite.py`
✓ Fresh baseline migration: `0001_baseline.py`
Frontend (pending)
- Login page (React Hook Form + Zod)
- Route protection
- Show nav items by role
Deliverable
✓ Backend auth works, role-based access works, tenant isolation is enforced by design
- Frontend integration in progress

Week 3 — Cases v1 (renamed from Leads) ✓ COMPLETE
Backend
✓ 4 roles: intake_specialist, case_manager, manager, developer
✓ cases table:
  ✓ organization_id, source, meta_lead_id, contact fields, status, assigned_to, created_by, timestamps
  ✓ Sequential case_number per org (00001-99999)
  ✓ Phone normalization (E.164: +15551234567)
  ✓ State normalization (2-letter codes: CA, TX, etc.)
  ✓ Email unique per org (active cases only)
  ✓ Soft-delete (is_archived, archived_at, archived_by)
✓ case_status_history table (tracks all status changes with reason)
✓ case_notes table (2-4000 chars, author tracking)
✓ tasks table (due date, assignee, completion tracking)
✓ meta_leads table (raw ingestion skeleton)
✓ Endpoints:
  ✓ /cases (list with pagination max 100, search, filters)
  ✓ /cases CRUD + status change + assign
  ✓ /cases/:id/archive, /cases/:id/restore (manager+ only)
  ✓ /cases/:id/history (status timeline)
  ✓ /cases/:id/notes (list/create)
  ✓ /notes/:id (delete)
  ✓ /tasks (CRUD + complete/uncomplete)
  ✓ /webhooks/meta (verification skeleton)
Frontend
✓ Cases table (filters, search, status chips)
✓ Case detail page (edit, change status, assign)
Deliverable
✓ Backend complete: Cases module with full CRUD, notes, tasks, status history
✓ Frontend integration complete

Week 4 — Frontend UI (v0 Design Implementation) ✓ COMPLETE
Frontend (using v0.dev + shadcn/ui)
✓ Login page:
  ✓ Duo SSO primary button
  ✓ Collapsible username + Duo option
  ✓ Glassmorphism card with watercolor gradient background
✓ Dashboard page:
  ✓ Stats cards (Active Cases, Pending Tasks, etc.)
  ✓ Charts (bar, line using recharts)
  ✓ Recent activity list
✓ Cases List page:
  ✓ Status/source filters
  ✓ Search input
  ✓ Table with status badges, assignee avatars
  ✓ Actions menu, pagination
✓ Case Detail page:
  ✓ Tabs (Overview, Notes, Tasks, History)
  ✓ Status updates, assignment
✓ Tasks page:
  ✓ Grid layout with filters
  ✓ Priority/status badges
  ✓ Due date display
✓ Intended Parents page:
  ✓ Status filters, search
  ✓ Table with data, actions
  ✓ Pagination
✓ Reports page:
  ✓ 4 chart cards (bar, line, pie, horizontal bar)
  ✓ Quick stats row
  ✓ Export dropdown
✓ Settings page:
  ✓ 5 tabs: Profile, Organization, Notifications, Integrations, Security
  ✓ Forms with inputs, toggles, buttons
✓ Automation page:
  ✓ Workflows tab (toggle switches, kebab menu)
  ✓ Templates tab (grid of template cards)
✓ App Sidebar:
  ✓ Navigation links for all pages
  ✓ Organization name, user menu
  ✓ Logout functionality
✓ Loading skeletons for all pages
Deliverable
✓ Complete frontend UI with v0 design, ready for API integration

Week 5 — Frontend-Backend Integration ✓ COMPLETE
Backend
✓ /cases/stats endpoint (total, by_status, this_week, this_month, pending_tasks)
✓ XSS sanitization for notes using nh3 (allowed: p, br, strong, em, ul, ol, li, a, blockquote)
Frontend
✓ API client layer (apps/web/lib/api/cases.ts, tasks.ts, notes.ts)
✓ TypeScript types matching backend enums exactly
✓ React Query hooks for all operations
✓ Cases page wired to API:
  ✓ Status/source filters
  ✓ Debounced search (300ms)
  ✓ Pagination
  ✓ Archive/restore actions
✓ Case detail page wired to API:
  ✓ Contact info, demographics, eligibility from API
  ✓ Status change dropdown (12 stages)
  ✓ Notes tab with TipTap rich text editor
  ✓ Tasks tab with complete/uncomplete
  ✓ Status history timeline
✓ Dashboard wired to API:
  ✓ Stats cards from /cases/stats
  ✓ My Tasks section with complete toggle
  ✓ Cases by status breakdown
✓ Tasks page wired to API:
  ✓ My Tasks / All Tasks toggle
  ✓ Grouped by due date (overdue, today, tomorrow, this week, later)
  ✓ Complete/uncomplete toggle
  ✓ Show/hide completed section
Deliverable
✓ All frontend pages connected to real API data

Week 6 — Intended Parents Module + Dependencies ✓ COMPLETE
Backend
✓ IntendedParent model with full_name, email, phone, state, budget, notes_internal
✓ 7 status workflow: new → contacted → in_review → qualified → matched → declined → on_hold
✓ IntendedParentStatusHistory for change tracking
✓ Archive/restore with status preservation (restores to previous status from history)
✓ Duplicate email check on create and restore (returns 409 on conflict)
✓ State/phone normalization validators in Pydantic schemas
✓ Polymorphic EntityNote system supporting Cases and IPs (entity_type + entity_id)
✓ CSRF protection (require_csrf_header) on all mutation endpoints
✓ Pagination with pages field (total/per_page rounded up)
Frontend
✓ IP list page with stats cards, filters (status, search), pagination
✓ IP detail page with contact info, status dropdown, notes, history tabs
✓ React Query hooks for all IP API operations
✓ TypeScript types for IP and EntityNote
Dependencies (2025-12-14)
✓ Next.js 15.5.9 → 16.0.10
✓ React 19.2.0 → 19.2.3
✓ Zod 3.x → 4.1.13
✓ recharts 2.x → 3.5.1 (rewrote ChartTooltipContent/ChartLegendContent)
✓ All Radix UI components to latest
✓ Base UI combobox/pagination fixed for render prop compatibility
Deliverable
✓ Full Intended Parents CRUD with proper security, normalization, and frontend integration

═══════════════════════════════════════════════════════════════════════════════
DEFERRED IMPROVEMENTS (Technical Debt / Future Enhancements)
═══════════════════════════════════════════════════════════════════════════════

Metadata API for Picklists (Week 10-11)
- Problem: Status/source/type enums are duplicated in backend enums.py and frontend types
- Solution: Add /metadata/statuses, /metadata/task-types endpoints
  - Frontend fetches allowed values on load, populates dropdowns dynamically
  - Single source of truth, no manual sync needed
- Enables: Admin-managed picklists, versioned taxonomy with migration scripts

Task Search (Week 10-11)
- Problem: Backend /tasks endpoint has no search/filter by title/description
- Solution: Add `q` query param to /tasks for server-side search
  - Also add: due_before, due_after params for date filtering
- Enables: Search UI in tasks page, better filtering for large task lists

Case Inline Editing (Week 6+)
- Problem: Case detail shows data but can't edit most fields inline
- Solution: Inline editing for simple fields (name, email, phone)
  - Modal for complex edits (demographics, eligibility)
- Enables: Faster data entry without leaving the page

═══════════════════════════════════════════════════════════════════════════════

Week 5b — Workflow automation + email foundation (reminders/jobs/templates) ✓ COMPLETE
Backend
✓ Minimal job/outbox system (DB-backed) for:
  ✓ scheduled reminders (follow-ups)
  ✓ webhook processing retries (future Meta)
  ✓ notification fan-out (future)
✓ Email foundation (automated email is a V1 requirement):
  ✓ message log table (org-scoped) for outbound emails tied to leads/cases
  ✓ template/snippet storage (org-configurable)
  ✓ send pipeline via the jobs/outbox system (schedule + retry + audit)
✓ Tables:
  ✓ jobs (organization_id, type, payload, run_at, attempts, status)
  ✓ email_templates (organization_id, name, subject, body_html)
  ✓ email_logs (organization_id, entity references, status, timestamps)
✓ Worker process (simple polling worker)
Frontend
✓ Automation page with Workflows + Templates tabs
✓ UI scaffolds for follow-up rules and email templates
Deliverable
✓ You can schedule and reliably run org-scoped background tasks
✓ Email sending is logged and can be scheduled

Week 6 — Intended parents module ✓ COMPLETE (see Week 6 above for full details)
Backend
✓ intended_parents table + CRUD endpoints (org-scoped)
✓ Filters by status/state/budget
Frontend
✓ Intended parents list/detail pages
✓ Status management
Deliverable
✓ Parents stored cleanly and searchable for matching

Week 7 — Cases module (specialists workflow) ✓ COMPLETE (moved to Week 3)
Note: Cases module was completed as part of Week 3 with full CRUD, notes, tasks, and status history.
See Week 3 section above for complete details.

Week 8 — Notifications v1
Backend
- notifications table
- Triggers:
  - lead assigned
  - case assigned
  - status change
- Endpoints: GET `/me/notifications`, mark as read
Frontend
- Notification bell dropdown
- Notifications page (optional)
Deliverable
- Real-time-ish workflow (polling is fine for V1)

Week 9 — Meta Lead Ads integration (real-time lead sync)
Backend
- Webhook endpoint for Meta leadgen events
- Verify callback (hub.challenge pattern)
- On webhook:
  - log payload (carefully; avoid storing raw PII unredacted)
  - enqueue job to fetch lead details via Meta API
  - map fields → Lead schema
  - upsert by meta_lead_id (dedupe)
  - retry logic via jobs/outbox system
Frontend
- “META” source badge
- Filter by source=META
Deliverable
- A real Meta lead appears in your CRM automatically

Week 10 — Manager analytics (daily/weekly/monthly/custom) + AI-ready insights tab
Backend
- Analytics endpoints:
  - leads by status over time
  - funnel counts
  - cases by status and by specialist
- If you added status_history, use it here
Frontend
- Reports dashboard
- Date range picker + charts
- “Insights” tab scaffolding (works without AI; AI enhances it later)
Deliverable
- Managers have the “overview + stats” view they asked for

Week 11 — AI assistant v1 (safe + useful, BYOK)
Backend
- Org AI settings + key storage:
  - store provider key encrypted at rest; write-only; masked display; manager-only updates
  - org policy toggles (enabled, allowed features)
- Endpoints (org + role scoped):
  - `/ai/summarize-lead`
  - `/ai/draft-email`
  - `/ai/analyze-dashboard`
- AI audit logging (prompt template version, model, redaction, latency/cost metadata)
Frontend
- “AI” panel on lead/case detail:
  - summary
  - suggested next steps
  - draft email button (user must edit/approve)
- Manager toggle to enable AI + set key
Deliverable
- AI saves time without auto-sending anything; org turns it on once for the team

Week 12 — Hardening + deployment + open-source readiness
Hardening
- Add indexes (organization_id + status + created_at + assigned_to)
- Rate limiting on auth and webhooks
- Tight CORS config
- Error tracking (optional Sentry)
- Backups plan (Supabase tier-dependent; confirm)
Deployment
- Frontend: Vercel
- Backend: Render/Railway/Fly.io
- DB: Supabase
- Domain + HTTPS
Open-source readiness
- Clean README setup steps + `.env.example` completeness
- Seed script for demo data
- Clarify “core vs customization”:
  - per-org settings (pipelines/statuses/templates/rubrics/AI policy) in config tables
  - avoid per-client forks
- Decide license if/when you open-source (MIT/Apache/AGPL depending on goals)
Deliverable
- Safer, faster, production-ready behavior + clear path to a general OSS core

Week 13 — User Theme Customization (Optional Enhancement)
Frontend
- Theme provider context (next-themes or custom)
- 4-5 preset color themes (Teal, Blue, Purple, Rose, Orange)
- Theme selector in Settings page
- Store preference in localStorage + optionally user profile
- Light/Dark mode toggle
Backend (optional)
- User settings table field for theme preference
- Sync preference across devices
Deliverable
- Users can personalize the CRM appearance with preset themes

---

Deferred Improvements (Future Work)
-----------------------------------

Dependencies (2025-12-14) — COMPLETED
- Upgraded to Next.js 16, React 19.2.3, Zod 4, latest Radix UI
- recharts upgraded to v3.5.1 — Rewrote ChartTooltipContent and ChartLegendContent
  with custom TypeScript interfaces compatible with recharts 3 API
- Base UI components (combobox, pagination) fixed for render prop compatibility

