Surrogacy CRM Platform — 12-Week Roadmap (AI-ready, Multi-tenant, OSS-ready)
Last updated: 2025-12-16

Assumptions (important)
- Multi-tenant via shared DB + shared schema, with `organization_id` on all domain rows.
- Each user account belongs to exactly ONE organization (no org switcher). If the same person works for another org, they create a separate account.
- Tenant context is derived from auth (JWT/session includes `org_id` and `role`); the client does NOT send an org id header/path for scoping.
- AI is optional (off by default) and BYOK (org-managed key stored server-side in DB, encrypted).

Week 1 — Setup & foundations (repo + tooling + skeleton apps) ✓ COMPLETE
Backend
✓ FastAPI project structure (`apps/api/app/`)
✓ Postgres connectivity (Docker Compose for dev)
✓ Alembic migrations + baseline migration (`0001_baseline.py`)
✓ Central request context dependency (`get_current_session` returns `{user_id, org_id, role}`)
✓ `/health` endpoint (DB connectivity test)
Frontend
✓ Next.js App Router + TypeScript strict
✓ Tailwind + shadcn/ui installed
✓ Layout shell (sidebar/topbar) + placeholder routes (`(app)/dashboard`, `(app)/leads`, `(app)/settings`)
Tooling/Process
- CI on PRs: (to be configured)
✓ `.env` settings documented in README (formal `.env.example` files pending)
Deliverable
✓ FE loads, BE loads, DB connects; skeleton exists

Week 2 — Auth + tenant isolation (the "don't regret later" week) ✓ COMPLETE
Backend
✓ Tables:
  ✓ organizations
  ✓ users
  ✓ memberships (user_id ↔ org_id ↔ role) with constraint enforcing 1 org per user (UNIQUE(user_id))
  ✓ auth_identities (SSO provider linking)
  ✓ org_invites (with partial unique index for pending invites)
✓ Auth: Google OAuth (Workspace SSO) + cookie-based session (JWT in HTTP-only cookie) + GET `/auth/me`
✓ Invite-only access (org_invites + CLI bootstrap command)
✓ Optional domain allowlist via `ALLOWED_EMAIL_DOMAINS`
✓ CSRF protection for mutations (`X-Requested-With: XMLHttpRequest`)
✓ Centralized authorization helpers (role checks; membership checks) in `core/deps.py`
✓ Centralized query scoping helper: `get_org_scope` dependency
✓ Seed/bootstrap path:
  ✓ CLI: `python -m app.cli create-org` for first org + manager invite
  ✓ Dev-only endpoints (`/dev/seed`, `/dev/login-as`) guarded by ENV + X-Dev-Secret header
✓ Service layer: `auth_service.py`, `user_service.py`, `org_service.py`, `google_oauth.py`
✓ Schemas: `auth.py`, `user.py`, `org.py`, `invite.py`
✓ Fresh baseline migration: `0001_baseline.py`
Frontend (pending)
- Login page (React Hook Form + Zod)
- Route protection
- Show nav items by role
Deliverable
✓ Backend auth works, role-based access works, tenant isolation is enforced by design
- Frontend integration in progress

Week 3 — Cases v1 (renamed from Leads) ✓ COMPLETE
Backend
✓ 4 roles: intake_specialist, case_manager, manager, developer
✓ cases table:
  ✓ organization_id, source, meta_lead_id, contact fields, status, assigned_to, created_by, timestamps
  ✓ Sequential case_number per org (00001-99999)
  ✓ Phone normalization (E.164: +15551234567)
  ✓ State normalization (2-letter codes: CA, TX, etc.)
  ✓ Email unique per org (active cases only)
  ✓ Soft-delete (is_archived, archived_at, archived_by)
✓ case_status_history table (tracks all status changes with reason)
✓ case_notes table (2-4000 chars, author tracking)
✓ tasks table (due date, assignee, completion tracking)
✓ meta_leads table (raw ingestion skeleton)
✓ Endpoints:
  ✓ /cases (list with pagination max 100, search, filters)
  ✓ /cases CRUD + status change + assign
  ✓ /cases/:id/archive, /cases/:id/restore (manager+ only)
  ✓ /cases/:id/history (status timeline)
  ✓ /cases/:id/notes (list/create)
  ✓ /notes/:id (delete)
  ✓ /tasks (CRUD + complete/uncomplete)
  ✓ /webhooks/meta (verification skeleton)
Frontend
✓ Cases table (filters, search, status chips)
✓ Case detail page (edit, change status, assign)
Deliverable
✓ Backend complete: Cases module with full CRUD, notes, tasks, status history
✓ Frontend integration complete

Week 4 — Frontend UI (v0 Design Implementation) ✓ COMPLETE
Frontend (using v0.dev + shadcn/ui)
✓ Login page:
  ✓ Duo SSO primary button
  ✓ Collapsible username + Duo option
  ✓ Glassmorphism card with watercolor gradient background
✓ Dashboard page:
  ✓ Stats cards (Active Cases, Pending Tasks, etc.)
  ✓ Charts (bar, line using recharts)
  ✓ Recent activity list
✓ Cases List page:
  ✓ Status/source filters
  ✓ Search input
  ✓ Table with status badges, assignee avatars
  ✓ Actions menu, pagination
✓ Case Detail page:
  ✓ Tabs (Overview, Notes, Tasks, History)
  ✓ Status updates, assignment
✓ Tasks page:
  ✓ Grid layout with filters
  ✓ Priority/status badges
  ✓ Due date display
✓ Intended Parents page:
  ✓ Status filters, search
  ✓ Table with data, actions
  ✓ Pagination
✓ Reports page:
  ✓ 4 chart cards (bar, line, pie, horizontal bar)
  ✓ Quick stats row
  ✓ Export dropdown
✓ Settings page:
  ✓ 5 tabs: Profile, Organization, Notifications, Integrations, Security
  ✓ Forms with inputs, toggles, buttons
✓ Automation page:
  ✓ Workflows tab (toggle switches, kebab menu)
  ✓ Templates tab (grid of template cards)
✓ App Sidebar:
  ✓ Navigation links for all pages
  ✓ Organization name, user menu
  ✓ Logout functionality
✓ Loading skeletons for all pages
Deliverable
✓ Complete frontend UI with v0 design, ready for API integration

Week 5 — Frontend-Backend Integration ✓ COMPLETE
Backend
✓ /cases/stats endpoint (total, by_status, this_week, this_month, pending_tasks)
✓ XSS sanitization for notes using nh3 (allowed: p, br, strong, em, ul, ol, li, a, blockquote)
Frontend
✓ API client layer (apps/web/lib/api/cases.ts, tasks.ts, notes.ts)
✓ TypeScript types matching backend enums exactly
✓ React Query hooks for all operations
✓ Cases page wired to API:
  ✓ Status/source filters
  ✓ Debounced search (300ms)
  ✓ Pagination
  ✓ Archive/restore actions
✓ Case detail page wired to API:
  ✓ Contact info, demographics, eligibility from API
  ✓ Status change dropdown (12 stages)
  ✓ Notes tab with TipTap rich text editor
  ✓ Tasks tab with complete/uncomplete
  ✓ Status history timeline
✓ Dashboard wired to API:
  ✓ Stats cards from /cases/stats
  ✓ My Tasks section with complete toggle
  ✓ Cases by status breakdown
✓ Tasks page wired to API:
  ✓ My Tasks / All Tasks toggle
  ✓ Grouped by due date (overdue, today, tomorrow, this week, later)
  ✓ Complete/uncomplete toggle
  ✓ Show/hide completed section
Deliverable
✓ All frontend pages connected to real API data

Week 5b — Workflow automation + email foundation (reminders/jobs/templates) ✓ COMPLETE
Backend
✓ Minimal job/outbox system (DB-backed) for:
  ✓ scheduled reminders (follow-ups)
  ✓ webhook processing retries (future Meta)
  ✓ notification fan-out (future)
✓ Email foundation (automated email is a V1 requirement):
  ✓ message log table (org-scoped) for outbound emails tied to leads/cases
  ✓ template/snippet storage (org-configurable)
  ✓ send pipeline via the jobs/outbox system (schedule + retry + audit)
✓ Tables:
  ✓ jobs (organization_id, type, payload, run_at, attempts, status)
  ✓ email_templates (organization_id, name, subject, body_html)
  ✓ email_logs (organization_id, entity references, status, timestamps)
✓ Worker process (simple polling worker)
Frontend
✓ Automation page with Workflows + Templates tabs
✓ UI scaffolds for follow-up rules and email templates
Deliverable
✓ You can schedule and reliably run org-scoped background tasks
✓ Email sending is logged and can be scheduled

Week 6a — Intended Parents Module + Dependencies ✓ COMPLETE
Backend
✓ intended_parents table + CRUD endpoints (org-scoped)
✓ Filters by status/state/budget
Frontend
✓ Intended parents list/detail pages
✓ Status management
Deliverable
✓ Parents stored cleanly and searchable for matching

Week 6b — Intended Parents Module + Dependencies ✓ COMPLETE
Backend
✓ IntendedParent model with full_name, email, phone, state, budget, notes_internal
✓ 7 status workflow: new → contacted → in_review → qualified → matched → declined → on_hold
✓ IntendedParentStatusHistory for change tracking
✓ Archive/restore with status preservation (restores to previous status from history)
✓ Duplicate email check on create and restore (returns 409 on conflict)
✓ State/phone normalization validators in Pydantic schemas
✓ Polymorphic EntityNote system supporting Cases and IPs (entity_type + entity_id)
✓ CSRF protection (require_csrf_header) on all mutation endpoints
✓ Pagination with pages field (total/per_page rounded up)
Frontend
✓ IP list page with stats cards, filters (status, search), pagination
✓ IP detail page with contact info, status dropdown, notes, history tabs
✓ React Query hooks for all IP API operations
✓ TypeScript types for IP and EntityNote
Dependencies (2025-12-14)
✓ Next.js 15.5.9 → 16.0.10
✓ React 19.2.0 → 19.2.3
✓ Zod 3.x → 4.1.13
✓ recharts 2.x → 3.5.1 (rewrote ChartTooltipContent/ChartLegendContent)
✓ All Radix UI components to latest
✓ Base UI combobox/pagination fixed for render prop compatibility
Deliverable
✓ Full Intended Parents CRUD with proper security, normalization, and frontend integration

Week 6c — Case Handoff Workflow ✓ COMPLETE
Backend
✓ Added PENDING_HANDOFF status to CaseStatus enum
✓ Auto-transition: approved → pending_handoff
✓ Centralized access control (case_access.py):
  ✓ check_case_access() - raises 403 if intake tries to access post-handoff cases
  ✓ can_modify_case() - checks modification rights per role
✓ Transition guards - intake cannot set CASE_MANAGER_ONLY statuses
✓ Access checks on notes and tasks routers
✓ Endpoints (case_manager+ only):
  ✓ GET /cases/handoff-queue - list pending handoff cases
  ✓ POST /cases/{id}/accept - accept handoff (→ pending_match)
  ✓ POST /cases/{id}/deny - deny with optional reason (→ under_review)
Frontend
✓ Cases page - Tabs (All Cases / Pending Handoff)
✓ Pending Handoff tab (case_manager+ only) with Accept/Deny buttons
✓ Badge with count on Pending Handoff tab
✓ Deny dialog with reason textarea
✓ STATUS_CONFIG entry for pending_handoff
Deliverable
✓ Complete intake → case manager handoff workflow with role-based access control

Week 6d — Case Management Enhancements ✓ COMPLETE
Backend
✓ Priority Cases:
  ✓ Added is_priority boolean field to Case model
  ✓ Toggle priority from cases list and detail pages
  ✓ Gold highlighting for priority cases in table
✓ Case Activity Logging (CaseActivityLog model):
  ✓ 12 activity types: case_created, info_edited, status_changed, assigned,
    unassigned, priority_changed, archived, restored, handoff_accepted,
    handoff_denied, note_added, note_deleted
  ✓ JSONB details field for type-specific data
  ✓ Activity service with helper functions for each type
  ✓ Assignment tracking captures from→to on reassignment
  ✓ GET /cases/{id}/activity endpoint (paginated)
✓ Bulk Operations:
  ✓ GET /cases/assignees endpoint for user picker
  ✓ POST /cases/bulk-assign endpoint (case_manager+ role)
  ✓ ROLES_CAN_ASSIGN updated to include case_manager
  ✓ ROLES_CAN_ARCHIVE updated to include all roles
✓ Case Inline Editing:
  ✓ Edit dialog in case detail page
  ✓ All editable fields: name, email, phone, state, DOB, demographics
Frontend
✓ Multi-Select Cases:
  ✓ Checkbox column with "select all" in table header
  ✓ Row checkboxes for individual selection
  ✓ Floating action bar when cases selected
  ✓ "Assign to..." dropdown (case_manager+ only)
  ✓ "Archive" button (all roles)
  ✓ Selection count and Clear button
✓ Activity Log Tab:
  ✓ Renamed from "Status History" to "Activity Log"
  ✓ Uses useCaseActivity hook (paginated)
  ✓ Human-readable activity type labels
  ✓ Formatted details for each activity type
Deliverable
✓ Comprehensive case history tracking and bulk operations UI

═══════════════════════════════════════════════════════════════════════════════
DEFERRED IMPROVEMENTS (Technical Debt / Future Enhancements)
═══════════════════════════════════════════════════════════════════════════════

Metadata API for Picklists (Week 10-11)
- Problem: Status/source/type enums are duplicated in backend enums.py and frontend types
- Solution: Add /metadata/statuses, /metadata/task-types endpoints
  - Frontend fetches allowed values on load, populates dropdowns dynamically
  - Single source of truth, no manual sync needed
- Enables: Admin-managed picklists, versioned taxonomy with migration scripts

Task Search (Week 10-11)
- Problem: Backend /tasks endpoint has no search/filter by title/description
- Solution: Add `q` query param to /tasks for server-side search
  - Also add: due_before, due_after params for date filtering
- Enables: Search UI in tasks page, better filtering for large task lists

Case Inline Editing (Week 6+)
- Problem: Case detail shows data but can't edit most fields inline
- Solution: Inline editing for simple fields (name, email, phone)
  - Modal for complex edits (demographics, eligibility)
- Enables: Faster data entry without leaving the page

═══════════════════════════════════════════════════════════════════════════════

Week 7 — Cases module (specialists workflow) ✓ COMPLETE (moved to Week 3)
Note: Cases module was completed as part of Week 3 with full CRUD, notes, tasks, and status history.
See Week 3 section above for complete details.

Week 8 — In-App Notifications + Theme System ✓ COMPLETE
Backend
✓ Notification model with:
  ✓ organization_id, user_id, type, title, body, entity_type, entity_id
  ✓ dedupe_key for preventing duplicate notifications (1-hour window)
  ✓ read_at for read status tracking
  ✓ Proper indexes for performance
✓ UserNotificationSettings model:
  ✓ Per-user toggles: case_assigned, case_status_changed, case_handoff, task_assigned
  ✓ Defaults to all ON if no row exists
  ✓ Org-scoped for multi-tenancy
✓ NotificationType enum (6 types):
  ✓ CASE_ASSIGNED, CASE_STATUS_CHANGED, CASE_HANDOFF_READY
  ✓ CASE_HANDOFF_ACCEPTED, CASE_HANDOFF_DENIED, TASK_ASSIGNED
✓ Notification service (notification_service.py):
  ✓ create_notification() with dedupe logic (org+user scoped)
  ✓ get_notifications(), get_unread_count() with org-scoping
  ✓ mark_read(), mark_all_read() with org_id for tenant isolation
  ✓ get_user_settings(), update_user_settings() org-scoped
  ✓ Trigger functions: notify_case_assigned, notify_case_status_changed,
    notify_case_handoff_ready, notify_case_handoff_accepted,
    notify_case_handoff_denied, notify_task_assigned
✓ Triggers integrated into services:
  ✓ case_service.py: assign_case, update_status, accept_handoff, deny_handoff
  ✓ task_service.py: create_task, update_task (reassignment detection)
✓ Endpoints (notifications router):
  ✓ GET /me/notifications (paginated list with unread_count)
  ✓ GET /me/notifications/count (polling endpoint)
  ✓ PATCH /me/notifications/{id}/read (mark single read)
  ✓ POST /me/notifications/read-all (mark all read)
  ✓ GET /me/settings/notifications (get user preferences)
  ✓ PATCH /me/settings/notifications (update preferences)
✓ CSRF protection on all mutation endpoints
Frontend
✓ Theme System:
  ✓ ThemeProvider using next-themes (system/light/dark)
  ✓ ThemeToggle dropdown in header (sun/moon icon)
  ✓ Stone base + Teal theme colors for both modes
  ✓ Dark mode with warm Stone grays (not pure black)
  ✓ Teal-tinted secondary/accent buttons
✓ Notification Components:
  ✓ NotificationBell component with unread badge
  ✓ Dropdown with recent notifications list
  ✓ Click-through navigation to cases/tasks
  ✓ "Mark all read" button
  ✓ Header placement (all pages via AppSidebar)
✓ Notifications API client (lib/api/notifications.ts)
✓ React Query hooks:
  ✓ useNotifications, useUnreadCount (30s polling)
  ✓ useMarkRead, useMarkAllRead
  ✓ useNotificationSettings, useUpdateNotificationSettings
✓ Notifications page (/notifications):
  ✓ Full list view with mark read functionality
  ✓ Time-relative timestamps
  ✓ Empty state handling
✓ Settings page wired to real API:
  ✓ NotificationsSettingsCard component
  ✓ Real-time toggles for all 4 notification types
  ✓ Uses useNotificationSettings/useUpdateNotificationSettings hooks
Bug Fixes
✓ DropdownMenuLabel Menu.Group error - replaced with styled div
✓ Cases table scroll - header/filters fixed, only table scrolls
✓ mark_read() - added org_id for tenant isolation
✓ Dedupe query - added org_id + user_id for multi-tenancy safety
Deferred (TODO in job_service.py)
- TASK_DUE_TODAY notifications (requires daily worker)
- TASK_OVERDUE notifications (requires daily worker)
- DB unique constraint on dedupe_key (if concurrent inserts become noisy)
Deliverable
✓ Complete in-app notification system with theme toggle

Week 9 — Meta Lead Ads Integration ✓ COMPLETE
Backend
✓ Webhook endpoint with HMAC signature verification
✓ Verify callback (hub.challenge pattern)
✓ On webhook:
  ✓ Validate payload size and signature
  ✓ Enqueue META_LEAD_FETCH job with idempotency
  ✓ Worker fetches lead details via Meta API
  ✓ Auto-convert to Case (source=META)
  ✓ Campaign tracking: meta_ad_id, meta_form_id on Case
✓ Meta Conversions API (CAPI):
  ✓ Sends lead quality signals when status → qualified/approved
  ✓ Hashed email/phone for better Meta user matching
  ✓ Event deduplication via event_id
  ✓ Proper logging of success/failure
✓ CLI: update-meta-page-token, deactivate-meta-page
✓ Fernet encryption for page access tokens
✓ Dev endpoints: /dev/meta-leads/alerts, /dev/meta-leads/all
Frontend
✓ "META" source badge in Cases list
✓ Filter by source=META
✓ New statuses: qualified, applied (intake workflow enhancement)
Workflow Changes
✓ New status flow: new → contacted → qualified → applied → under_review → approved → pending_handoff
✓ Removed auto-transition approved → pending_handoff (intake manually submits)
Deliverable
✓ Meta leads auto-convert to Cases with campaign tracking
✓ CAPI feedback optimizes Meta ad targeting for higher-quality leads

Week 10 — Ops Console + Manager Analytics ✓ COMPLETE
Backend (Database + Services)
✓ Migration 0008_integration_health.py:
  ✓ integration_health - per-integration status tracking (status, config_status, last_success/error)
  ✓ integration_error_rollup - hourly error counts for 24h totals
  ✓ system_alerts - deduplicated actionable alerts with fingerprinting
  ✓ request_metrics_rollup - aggregated API metrics (multi-replica safe)
✓ New enums: IntegrationType, IntegrationStatus, AlertType, AlertSeverity, AlertStatus
✓ Services:
  ✓ ops_service.py - integration health tracking, success/error recording, hourly rollups
  ✓ alert_service.py - fingerprint-based deduplication, lifecycle management
  ✓ metrics_service.py - request metrics with DB upserts
✓ Worker integration:
  ✓ _record_job_success() - records success for META_LEAD_FETCH, META_CAPI_EVENT jobs
  ✓ _record_job_failure() - records errors, creates alerts on max retry failures
  ✓ Proper integration_key extraction (page_id or meta_page_id)
  ✓ Actual exception class for alert fingerprinting
✓ Scheduled token check endpoint:
  ✓ POST /internal/scheduled/token-check (X-Internal-Secret protected)
  ✓ Daily sweep for META_TOKEN_EXPIRING (< 7 days) and META_TOKEN_EXPIRED alerts
  ✓ Updates integration_health config_status accordingly
Backend (Analytics Endpoints)
✓ GET /analytics/summary - total cases, new this period, qualified rate, avg time to qualified
✓ GET /analytics/cases/by-status - case counts grouped by status
✓ GET /analytics/cases/by-assignee - case counts grouped by assignee
✓ GET /analytics/cases/trend - case creation trend (day/week/month bucketing)
✓ GET /analytics/meta/performance - Meta Lead Ads performance (leads, conversions, avg time)
Backend (Ops Endpoints)
✓ GET /ops/health - integration health status for all integrations
✓ GET /ops/alerts/summary - open alert counts by severity (warn/error/critical)
✓ GET /ops/alerts - list alerts with status/severity filters, pagination
✓ POST /ops/alerts/{id}/resolve - resolve alert (CSRF protected)
✓ POST /ops/alerts/{id}/acknowledge - acknowledge alert (CSRF protected)
✓ POST /ops/alerts/{id}/snooze - snooze alert for N hours (CSRF protected)
Frontend
✓ /reports page - real data from analytics API:
  ✓ Summary stats (total cases, new, qualified rate, Meta conversion)
  ✓ Cases by status bar chart
  ✓ Cases trend line chart with period selector
  ✓ Team performance by assignee
  ✓ Meta Lead Ads performance panel
✓ /settings/alerts page:
  ✓ Alert summary cards (critical/error/warn counts)
  ✓ Alert list with status filter
  ✓ Resolve/Acknowledge/Snooze actions
✓ /settings/integrations page:
  ✓ Integration health cards with status indicator
  ✓ Config status (configured/expired_token/missing_token)
  ✓ Error counts and last error display
✓ API clients + React Query hooks:
  ✓ lib/api/analytics.ts, lib/api/ops.ts
  ✓ lib/hooks/use-analytics.ts, lib/hooks/use-ops.ts
Security Fixes (code review)
✓ CSRF headers on ops mutation endpoints
✓ Literal types for query params (prevents 500 on bad enum)
✓ count_alerts includes severity for consistent pagination
✓ Token-check handles naive datetime comparison
✓ Use 'default' instead of NULL for integration_key upserts
✓ Analytics qualified_statuses includes all post-qualified stages
✓ Trend endpoint excludes archived cases
Permissions
✓ All ops/analytics endpoints require manager or developer role
✓ CSRF protection on all state-changing POST endpoints
Deliverable
✓ Enterprise-grade integration health tracking and alerting system
✓ Manager analytics dashboard with real-time data

Week 10+ — AI Assistant Tab + Meta Ads Spend + UI Refinements ✓ COMPLETE
Backend
✓ ai_enabled boolean field on Organization model (default False)
✓ Updated /auth/me to include ai_enabled from org
✓ GET /analytics/meta/spend endpoint:
  ✓ fetch_ad_account_insights() in meta_api.py
  ✓ CampaignSpend and MetaSpendSummary schemas
  ✓ Mock data when META_TEST_MODE=true
Frontend
✓ AI Assistant page (/ai-assistant):
  ✓ ChatGPT-style layout (fixed chat, scrollable sidebar)
  ✓ Quick Actions, Suggested Actions, Past Conversations
  ✓ Full viewport height: h-[calc(100vh-4rem)]
✓ AI sidebar link conditional on user.ai_enabled
✓ Ad Spend card in Reports (total spend, CPL)
✓ Theme toggle animation (View Transitions API, circle blur from top-left)
✓ Global font changed to Noto Sans
✓ DateRangePicker UX improvements (stays open during selection)
Bug Fixes (Meta Spend):
✓ META_AD_ACCOUNT_ID and META_SYSTEM_TOKEN added to Settings class
✓ META_TEST_MODE now defaults False (safer for production)
✓ Errors are logged with logger.error/warning
✓ safe_float/safe_int handle empty strings and string numbers
✓ Checks multiple action types (lead, leadgen, pixel conversions)
✓ Pagination handling (up to 10 pages / 1000 campaigns)
✓ Updated .env.example with new settings
Deliverable
✓ AI Assistant UI ready for backend chat integration
✓ Meta spend data visible in Reports dashboard

Week 11 — AI assistant v1 (safe + useful, BYOK)
Backend
- Org AI settings + key storage:
  - store provider key encrypted at rest; write-only; masked display; manager-only updates
  - org policy toggles (enabled, allowed features)
- Endpoints (org + role scoped):
  - `/ai/summarize-lead`
  - `/ai/draft-email`
  - `/ai/analyze-dashboard`
- AI audit logging (prompt template version, model, redaction, latency/cost metadata)
Frontend
- “AI” panel on lead/case detail:
  - summary
  - suggested next steps
  - draft email button (user must edit/approve)
- Manager toggle to enable AI + set key
Deliverable
- AI saves time without auto-sending anything; org turns it on once for the team

Week 12 — Hardening + deployment + open-source readiness
Hardening
- Add indexes (organization_id + status + created_at + assigned_to)
- Rate limiting on auth and webhooks
- Tight CORS config
- Error tracking (optional Sentry)
- Backups plan (Supabase tier-dependent; confirm)
Deployment
- Frontend: Vercel
- Backend: Render/Railway/Fly.io
- DB: Supabase
- Domain + HTTPS
Open-source readiness
- Clean README setup steps + `.env.example` completeness
- Seed script for demo data
- Clarify “core vs customization”:
  - per-org settings (pipelines/statuses/templates/rubrics/AI policy) in config tables
  - avoid per-client forks
- Decide license if/when you open-source (MIT/Apache/AGPL depending on goals)
Deliverable
- Safer, faster, production-ready behavior + clear path to a general OSS core

Week 13 — User Theme Customization (Optional Enhancement)
Frontend
- Theme provider context (next-themes or custom)
- 4-5 preset color themes (Teal, Blue, Purple, Rose, Orange)
- Theme selector in Settings page
- Store preference in localStorage + optionally user profile
- Light/Dark mode toggle
Backend (optional)
- User settings table field for theme preference
- Sync preference across devices
Deliverable
- Users can personalize the CRM appearance with preset themes

---

Deferred Improvements (Future Work)
-----------------------------------

Dependencies (2025-12-14) — COMPLETED
- Upgraded to Next.js 16, React 19.2.3, Zod 4, latest Radix UI
- recharts upgraded to v3.5.1 — Rewrote ChartTooltipContent and ChartLegendContent
  with custom TypeScript interfaces compatible with recharts 3 API
- Base UI components (combobox, pagination) fixed for render prop compatibility

Queue/Ownership System (Week 14+)
- Problem: Current access control ties visibility to status, which limits flexibility
- Solution: Add ownership fields to Case model for enterprise-style routing:
  - owner_role (intake_specialist, case_manager) — current owning role
  - current_queue — assignment queue name for team-based routing
  - stage_owner_id — current stage owner (vs original creator)
- Enables:
  - Ownership-based access control (independent of status)
  - Assignment queues with auto-routing rules (like Salesforce Queue)
  - Team-based views (like HubSpot "owner/team" + pipeline stage)
  - Flexible handoff without overloading status meaning
- Pattern: Salesforce/HubSpot/Zendesk enterprise CRM patterns
